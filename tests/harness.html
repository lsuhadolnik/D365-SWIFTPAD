<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Harness</title>
  </head>
  <body>
    <script>
      const params = new URLSearchParams(location.search);
      const dist = params.get('dist');
      const loader = params.get('loader');
      window.recordedMessages = [];
      window.fetchLog = [];
      window.chrome = {
        runtime: {
          getURL: (p) => dist + '/' + p,
          sendMessage: (msg, cb) => {
            window.recordedMessages.push(msg);
            if (cb) cb();
          },
        },
        storage: {
          sync: { get: () => Promise.resolve({}), set: () => Promise.resolve() },
          local: {
            get: () => Promise.resolve({}),
            set: () => Promise.resolve(),
            clear: () => Promise.resolve(),
            remove: () => Promise.resolve(),
          },
        },
        action: {
          setBadgeBackgroundColor: () => {},
          setBadgeText: () => {},
          setTitle: () => {},
          enable: () => {},
          disable: () => {},
        },
        tabs: { create: () => {} },
        scripting: { executeScript: () => {} },
        declarativeNetRequest: { updateDynamicRules: (r, cb) => cb && cb(), getDynamicRules: (cb) => cb([]) },
      };
      const originalFetch = window.fetch.bind(window);
      window.fetch = (input, init) => {
        const url = typeof input === 'string' ? input : input.url;
        window.fetchLog.push(url);
        if (url.includes('EntityDefinitions')) {
          return Promise.resolve(
            new Response(
              JSON.stringify({
                value: [
                  {
                    LogicalName: 'account',
                    DisplayName: { UserLocalizedLabel: { Label: 'Account' } },
                    PrimaryIdAttribute: 'accountid',
                    PrimaryNameAttribute: 'name',
                    LogicalCollectionName: 'accounts',
                  },
                ],
              })
            )
          );
        }
        if (url.includes('RetrieveCurrentOrganization')) {
          return Promise.resolve(
            new Response(JSON.stringify({ Detail: { EnvironmentId: '1', FriendlyName: 'Test' } }))
          );
        }
        return Promise.resolve(new Response(JSON.stringify({ value: [] })));
      };
      window.Xrm = {
        Page: {
          context: { getClientUrl: () => location.origin, getVersion: () => '9.2', getUserId: () => '{user}' },
          data: { entity: { getEntityName: () => 'account', getId: () => '{id}' } },
          ui: { tabs: { forEach: () => {}, get: () => ({}) }, controls: { forEach: () => {} } },
        },
        Utility: { getGlobalContext: () => ({ getCurrentAppUrl: () => '' }) },
      };
    </script>
    <script type="module" id="loaderScript"></script>
    <script>
      document.getElementById('loaderScript').src = 'file://' + dist + '/' + loader;
    </script>
  </body>
</html>
